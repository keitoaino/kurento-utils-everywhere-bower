!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.kurentoUtils=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var freeice=require("freeice");function defaultOnerror(error){if(error)console.error(error)}function noop(){}function WebRtcPeer(mode,localVideo,remoteVideo,onsdpoffer,onerror,videoStream,audioStream){Object.defineProperty(this,"pc",{writable:true});this.localVideo=localVideo;this.remoteVideo=remoteVideo;this.onerror=onerror||defaultOnerror;this.stream=videoStream;this.audioStream=audioStream;this.mode=mode;this.onsdpoffer=onsdpoffer||noop}WebRtcPeer.prototype.start=function(server,options){var self=this;server=server||this.server;options=options||this.seoptionsrver;if(!this.pc){this.pc=new RTCPeerConnection(server,options)}var pc=this.pc;if(this.stream&&this.localVideo){attachMediaStream(this.localVideo,this.stream);this.localVideo.muted=true}if(this.stream){pc.addStream(this.stream)}if(this.audioStream){pc.addStream(this.audioStream)}this.constraints={mandatory:{OfferToReceiveAudio:this.remoteVideo!==undefined,OfferToReceiveVideo:this.remoteVideo!==undefined}};pc.createOffer(function(offer){console.log("Created SDP offer");pc.setLocalDescription(offer,function(){console.log("Local description set")},self.onerror)},this.onerror,this.constraints);var ended=false;pc.onicecandidate=function(e){if(e.candidate){ended=false;return}if(ended){return}var offerSdp=pc.localDescription.sdp;console.log("ICE negotiation completed");self.onsdpoffer(offerSdp,self);ended=true}};WebRtcPeer.prototype.dispose=function(){console.log("Disposing WebRtcPeer");if(this.pc&&this.pc.signalingState!="closed")this.pc.close();if(this.localVideo)this.localVideo.src="";if(this.remoteVideo)this.remoteVideo.src="";if(this.stream){this.stream.getAudioTracks().forEach(function(track){track.stop&&track.stop()});this.stream.getVideoTracks().forEach(function(track){track.stop&&track.stop()})}};WebRtcPeer.prototype.userMediaConstraints={audio:true,video:{mandatory:{maxWidth:640,maxFrameRate:15,minFrameRate:15}}};WebRtcPeer.prototype.processSdpAnswer=function(sdpAnswer,successCallback){var answer=new RTCSessionDescription({type:"answer",sdp:sdpAnswer});console.log("SDP answer received, setting remote description");var self=this;self.pc.setRemoteDescription(answer,function(){if(self.remoteVideo)attachMediaStream(self.remoteVideo,self.pc.getRemoteStreams()[0]);if(successCallback)successCallback()},this.onerror)};WebRtcPeer.prototype.server={iceServers:freeice()};WebRtcPeer.prototype.options={optional:[{DtlsSrtpKeyAgreement:true}]};WebRtcPeer.start=function(mode,localVideo,remoteVideo,onSdp,onerror,mediaConstraints,videoStream,audioStream,server,options){var wp=new WebRtcPeer(mode,localVideo,remoteVideo,onSdp,onerror,videoStream,audioStream);if(wp.mode!=="recv"&&!wp.stream){var constraints=mediaConstraints?mediaConstraints:wp.userMediaConstraints;getUserMedia(constraints,function(userStream){wp.stream=userStream;wp.start(server,options)},wp.onerror)}else{wp.start(server,options)}return wp};WebRtcPeer.startRecvOnly=function(remoteVideo,onSdp,onError,mediaConstraints,server,options){return WebRtcPeer.start("recv",null,remoteVideo,onSdp,onError,mediaConstraints,server,options)};WebRtcPeer.startSendOnly=function(localVideo,onSdp,onError,mediaConstraints,server,options){return WebRtcPeer.start("send",localVideo,null,onSdp,onError,mediaConstraints,server,options)};WebRtcPeer.startSendRecv=function(localVideo,remoteVideo,onSdp,onError,mediaConstraints,server,options){return WebRtcPeer.start("sendRecv",localVideo,remoteVideo,onSdp,onError,mediaConstraints,server,options)};module.exports=WebRtcPeer},{freeice:3}],2:[function(require,module,exports){var WebRtcPeer=require("./WebRtcPeer");exports.WebRtcPeer=WebRtcPeer},{"./WebRtcPeer":1}],3:[function(require,module,exports){"use strict";var normalice=require("normalice");var freeice=module.exports=function(opts){var servers={stun:(opts||{}).stun||require("./stun.json"),turn:(opts||{}).turn||require("./turn.json")};var stunCount=(opts||{}).stunCount||2;var turnCount=(opts||{}).turnCount||0;var selected;function getServers(type,count){var out=[];var input=[].concat(servers[type]);var idx;while(input.length&&out.length<count){idx=Math.random()*input.length|0;out=out.concat(input.splice(idx,1))}return out.map(function(url){return normalice(type+":"+url)})}selected=[].concat(getServers("stun",stunCount));if(turnCount){selected=selected.concat(getServers("turn",turnCount))}return selected}},{"./stun.json":5,"./turn.json":6,normalice:4}],4:[function(require,module,exports){var protocols=["stun:","turn:"];module.exports=function(input){var url=(input||{}).url||input;var protocol;var parts;var output={};if(typeof url!="string"&&!(url instanceof String)){return input}url=url.trim();protocol=protocols[protocols.indexOf(url.slice(0,5))];if(!protocol){return input}url=url.slice(5);parts=url.split("@");output.username=input.username;output.credential=input.credential;if(parts.length>1){url=parts[1];parts=parts[0].split(":");output.username=parts[0];output.credential=(input||{}).credential||parts[1]||""}output.url=protocol+url;output.urls=[output.url];return output}},{}],5:[function(require,module,exports){module.exports=["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302","stun.ekiga.net","stun.ideasip.com","stun.rixtelecom.se","stun.schlund.de","stun.stunprotocol.org:3478","stun.voiparound.com","stun.voipbuster.com","stun.voipstunt.com","stun.voxgratia.org","stun.services.mozilla.com"]},{}],6:[function(require,module,exports){module.exports=[]},{}]},{},[2])(2)});